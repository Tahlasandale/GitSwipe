<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitSwipe - Ultimate.bin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/a11y-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap');
        
        body { font-family: 'Space Mono', monospace; overflow: hidden; background-color: white; color: black; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 10px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: white; border-left: 4px solid black; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: black; border: 2px solid white; }
        
        /* Markdown Styles */
        .markdown-body { font-size: 12px; line-height: 1.5; overflow-x: hidden !important; width: 100% !important; }
        .markdown-body * { max-width: 100% !important; overflow-wrap: break-word !important; word-break: break-word !important; }
        .markdown-body h1, .markdown-body h2 { font-weight: 900; text-transform: uppercase; border-bottom: 4px solid #00FF00; margin: 20px 0 10px; }
        .markdown-body code { background: #00FF00; color: black; padding: 2px 4px; font-weight: bold; }
        .markdown-body pre { background: #111; color: #eee; padding: 15px; border: 4px solid black; margin: 15px 0; overflow-x: auto; }
        .markdown-body pre code { background: transparent; color: inherit; padding: 0; font-weight: normal; }
        .markdown-body ul { list-style: square; padding-left: 1.5rem; }
        
        .active-card { z-index: 10; transition: transform 0.2s cubic-bezier(0.19, 1, 0.22, 1); will-change: transform; }
        .active-card:active { cursor: grabbing; }

        @keyframes slideIn {
            from { transform: translate(-1000px, 0) rotate(-30deg); opacity: 0; }
            to { transform: translate(0, 0) rotate(0); opacity: 1; }
        }
        .card-undo-anim { animation: slideIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        /* Analyzer Specifics */
        .msg-user { background-color: #00FF00; color: black; border: 2px solid black; align-self: flex-end; margin-left: 20%; }
        .msg-ai { background-color: white; color: black; border: 2px solid black; align-self: flex-start; margin-right: 10%; }
        .typing-cursor::after { content: '▋'; animation: blink 1s step-start infinite; }
        @keyframes blink { 50% { opacity: 0; } }
    </style>
</head>
<body class="flex flex-col h-screen select-none">

    <!-- Header -->
    <header class="bg-black text-white border-b-4 border-black px-4 py-3 flex justify-between items-center z-[60] shrink-0 shadow-[0px_4px_0px_0px_rgba(0,0,0,1)]">
        <div class="flex items-center gap-3">
            <div class="bg-[#00FF00] p-1 border-2 border-white">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="3"><path d="M16 18l6-6-6-6M8 6l-6 6 6 6"/></svg>
            </div>
            <h1 class="font-black text-lg tracking-tighter uppercase italic hidden sm:block">GitSwipe</h1>
        </div>
        
        <nav class="flex gap-1.5">
            <button id="btn-trending" title="Trending" class="bg-[#00FF00] text-black border-2 border-white p-2 shadow-[2px_2px_0px_0px_rgba(255,255,255,1)] translate-x-[-1px] translate-y-[-1px] transition-all">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
            </button>
            <button id="btn-random" title="Random Chaos" class="hover:bg-white hover:text-black border-2 border-white p-2 transition-all">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><circle cx="15.5" cy="8.5" r="1.5"/><circle cx="8.5" cy="15.5" r="1.5"/><circle cx="15.5" cy="15.5" r="1.5"/><circle cx="12" cy="12" r="1.5"/></svg>
            </button>
            <button id="btn-search" title="Rechercher" class="hover:bg-white hover:text-black border-2 border-white p-2 transition-all">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>
            </button>
            <button id="btn-vault" title="Le Coffre" class="hover:bg-white hover:text-black border-2 border-white p-2 transition-all">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M21 8H3V6a2 2 0 012-2h14a2 2 0 012 2v2zM21 8v10a2 2 0 01-2 2H5a2 2 0 01-2-2V8h18zM12 12v4M10 12h4"/></svg>
            </button>
            <button id="btn-config" title="Configuration" class="bg-white text-black border-2 border-white p-2 hover:bg-[#00FF00] transition-colors">
                <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
                    <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2-.3l-.18-.18a2 2 0 0 0-2.83 0l-.31.31a2 2 0 0 0 0 2.83l.18.18a2 2 0 0 1 .3 2L3.2 11a2 2 0 0 1-1.73 1H1a2 2 0 0 0-2 2v.44a2 2 0 0 0 2 2h.18a2 2 0 0 1 1.73 1l.25.43a2 2 0 0 1-.3 2l-.18.18a2 2 0 0 0 0 2.83l.31.31a2 2 0 0 0 2.83 0l.18-.18a2 2 0 0 1 2 .3l.43.25a2 2 0 0 1 1 1.73V22a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 .3l.18.18a2 2 0 0 0 2.83 0l.31-.31a2 2 0 0 0-2.83l-.18-.18a2 2 0 0 1-.3-2l.25-.43a2 2 0 0 1 1.73-1H22a2 2 0 0 0 2-2v-.44a2 2 0 0 0-2-2h-.18a2 2 0 0 1-1-1.73-1l-.25-.43a2 2 0 0 1 .3-2l.18-.18a2 2 0 0 0 0-2.83l-.31-.31a2 2 0 0 0-2.83 0l-.18.18a2 2 0 0 1-2-.3l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/>
                    <circle cx="12" cy="12" r="3"/>
                </svg>
            </button>
        </nav>
    </header>

    <main class="relative flex-1 flex flex-col items-center p-4 overflow-hidden">
        
        <!-- View: Discover -->
        <div id="view-discover" class="w-full h-full flex flex-col items-center">
            <div id="card-container" class="relative w-full max-w-[420px] h-[78vh] mt-2">
                 <div class="flex flex-col items-center justify-center h-full gap-4">
                    <div class="w-12 h-12 border-4 border-black border-t-[#00FF00] animate-spin"></div>
                    <p class="font-black uppercase text-[10px] tracking-widest italic opacity-30 italic">Initializing_Deck...</p>
                </div>
            </div>
            <div id="feedback" class="hidden absolute top-1/2 -translate-y-1/2 z-50 px-10 py-5 border-4 border-black font-black text-4xl uppercase shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] pointer-events-none"></div>
            <div class="absolute bottom-6 flex items-center gap-8 z-[40]">
                <button onclick="completeSwipe('left')" class="w-16 h-16 bg-white border-4 border-black text-black flex items-center justify-center hover:bg-black hover:text-white shadow-[6px_6px_0px_0px_rgba(0,0,0,1)] active:shadow-none transition-all"><svg width="32" height="32" fill="none" stroke="currentColor" stroke-width="4" viewBox="0 0 24 24"><path d="M18 6L6 18M6 6l12 12"/></svg></button>
                <button id="btn-undo" onclick="undoLastSwipe()" class="w-12 h-12 bg-white border-4 border-black text-black flex items-center justify-center hover:bg-[#00FF00] shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] active:shadow-none transition-all opacity-30 cursor-not-allowed"><svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M3 10h10a8 8 0 0 1 8 8v2M3 10l6 6m-6-6l6-6"/></svg></button>
                <button onclick="completeSwipe('right')" class="w-16 h-16 bg-[#00FF00] border-4 border-black text-black flex items-center justify-center hover:bg-black hover:text-[#00FF00] shadow-[6px_6px_0px_0px_rgba(0,0,0,1)] active:shadow-none transition-all"><svg width="32" height="32" fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg></button>
            </div>
        </div>

        <!-- View: Vault -->
        <div id="view-vault" class="hidden w-full max-w-2xl overflow-y-auto custom-scrollbar h-full px-2 pt-4">
            <div class="flex justify-between items-end mb-8 border-b-8 border-[#00FF00] px-2 pb-2">
                <h2 id="vault-title" class="text-2xl font-black text-black uppercase italic leading-none">Vault</h2>
                <span id="vault-loading-indicator" class="hidden text-[10px] font-black uppercase text-black/30 animate-pulse italic">Refreshing...</span>
            </div>
            <div id="vault-list" class="space-y-4 pb-32"></div>
        </div>

        <!-- View: Analyzer (Gemini Chat) -->
        <div id="view-analyzer" class="hidden absolute inset-0 z-[70] bg-white flex flex-col h-full">
            <div class="bg-black text-[#00FF00] p-4 flex justify-between items-center border-b-4 border-black shrink-0">
                <div class="flex items-center gap-3 overflow-hidden">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/></svg>
                    <h2 id="analyzer-title" class="font-black text-lg uppercase truncate tracking-tighter">REPO_ANALYZER</h2>
                </div>
                <button onclick="closeAnalyzer()" class="bg-white text-black px-3 py-1 font-black uppercase text-xs border-2 border-[#00FF00] hover:bg-[#00FF00]">Exit</button>
            </div>
            
            <div id="analyzer-loading" class="hidden flex-1 flex flex-col items-center justify-center p-8 text-center bg-white">
                <div class="w-full max-w-xs bg-black border-4 border-black h-6 mb-4 relative">
                    <div id="analyzer-progress" class="bg-[#00FF00] h-full w-0 transition-all duration-300"></div>
                </div>
                <p id="analyzer-status" class="font-black text-xs uppercase animate-pulse">Scanning_File_Tree...</p>
                <p id="analyzer-details" class="text-[10px] font-mono mt-2 text-gray-500"></p>
            </div>

            <div id="analyzer-chat" class="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar bg-[#f4f4f4] relative">
                <div class="p-4 border-2 border-black bg-white shadow-[4px_4px_0px_0px_rgba(0,0,0,0.2)]">
                    <p class="font-bold text-xs uppercase mb-2 text-[#00FF00] bg-black inline-block px-1">SYSTEM</p>
                    <p class="text-xs">Initialisation de l'analyseur. Posez une question sur le code pour commencer.</p>
                </div>
            </div>

            <div class="p-4 bg-white border-t-4 border-black shrink-0">
                <div class="flex gap-2">
                    <input id="chat-input" type="text" placeholder="Query codebase..." class="flex-1 p-3 border-4 border-black font-mono text-sm focus:outline-none focus:border-[#00FF00] shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]">
                    <button onclick="sendMessage()" id="btn-send" class="bg-black text-[#00FF00] px-6 py-3 font-black uppercase text-xs border-4 border-black hover:bg-[#00FF00] hover:text-black shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] active:shadow-none transition-all">Send</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Search Modal -->
    <div id="search-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-sm p-4">
        <div class="bg-white border-4 border-black p-8 max-w-md w-full shadow-[15px_15px_0px_0px_rgba(0,255,0,1)]">
            <h3 class="font-black text-2xl uppercase mb-6 italic underline decoration-[#00FF00]">Search.exe</h3>
            <p class="text-[10px] font-bold mb-4 text-black/60 leading-relaxed uppercase">
                Recherchez un repo ("user/repo") ou des mots-clés ("linux ricing").
            </p>
            <input id="search-input" type="text" placeholder="Query..." class="w-full p-4 border-4 border-black mb-6 font-bold text-sm focus:outline-none focus:bg-indigo-50 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]">
            <div class="flex flex-col gap-3">
                <button id="btn-do-search" class="w-full bg-[#00FF00] border-4 border-black py-3 font-black uppercase text-xs shadow-[5px_5px_0px_0px_rgba(0,0,0,1)] active:shadow-none transition-all">Execute_Search</button>
                <button id="close-search" class="w-full bg-black text-white py-3 font-black uppercase text-xs">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Tags Editor Modal -->
    <div id="tags-modal" class="hidden fixed inset-0 z-[110] flex items-center justify-center bg-black/90 backdrop-blur-sm p-4">
        <div class="bg-white border-4 border-black p-8 max-w-md w-full shadow-[15px_15px_0px_0px_rgba(0,255,0,1)] flex flex-col h-[500px]">
            <h3 class="font-black text-2xl uppercase mb-6 italic underline decoration-[#00FF00]">Chaos_Matrix</h3>
            <p class="text-[10px] font-bold mb-4 text-black/60 leading-relaxed uppercase">
                Ajoutez ou supprimez les mots-clés utilisés par le mode "Random".
            </p>
            
            <div class="flex gap-2 mb-4">
                <input id="new-tag-input" type="text" placeholder="New tag (ex: docker)..." class="flex-1 p-2 border-4 border-black font-bold text-xs focus:outline-none focus:bg-indigo-50">
                <button id="add-tag-btn" class="bg-black text-[#00FF00] px-4 py-2 font-black uppercase text-xs border-4 border-black hover:bg-[#00FF00] hover:text-black">ADD</button>
            </div>

            <div id="tags-list" class="flex-1 overflow-y-auto border-4 border-black p-4 bg-[#f4f4f4] flex flex-wrap content-start gap-2 custom-scrollbar mb-4">
                <!-- Tags rendered here -->
            </div>

            <div class="flex gap-3 shrink-0">
                <button id="reset-tags" class="flex-1 bg-white border-4 border-black py-2 font-black uppercase text-[10px] text-red-600 hover:bg-red-50">Reset_Defaults</button>
                <button id="close-tags" class="flex-1 bg-black text-white py-3 font-black uppercase text-xs">Save & Exit</button>
            </div>
        </div>
    </div>

    <!-- Config Modal -->
    <div id="config-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-sm p-4">
        <div class="bg-white border-4 border-black p-8 max-w-md w-full shadow-[15px_15px_0px_0px_rgba(0,255,0,1)] relative">
            
            <!-- Bouton pour ouvrir l'éditeur de tags -->
            <button id="open-tags-btn" class="absolute top-8 right-8 border-2 border-black bg-white p-2 hover:bg-[#00FF00] shadow-[3px_3px_0px_0px_rgba(0,0,0,1)] active:shadow-none transition-all" title="Edit Random Tags">
                <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg>
            </button>

            <h3 class="font-black text-2xl uppercase mb-6 italic underline decoration-[#00FF00]">Config.sys</h3>
            
            <div class="mb-6">
                <label class="block text-[10px] font-black uppercase mb-2">GitHub Token (Classic)</label>
                <input id="gh-token-input" type="password" placeholder="ghp_XXXXXXXXXXXXXXXXXXXX" class="w-full p-3 border-4 border-black text-sm focus:outline-none focus:bg-indigo-50 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]">
                <p class="text-[9px] text-gray-500 mt-1">Requis pour Starrer et charger le code (Rate Limit)</p>
            </div>

            <div class="mb-8">
                <label class="block text-[10px] font-black uppercase mb-2">Gemini API Key</label>
                <input id="gemini-key-input" type="password" placeholder="AIzaSy..." class="w-full p-3 border-4 border-black text-sm focus:outline-none focus:bg-indigo-50 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]">
                <p class="text-[9px] text-gray-500 mt-1">Requise pour le chat avec le code. <a href="https://aistudio.google.com/app/apikey" target="_blank" class="underline hover:text-[#00FF00]">Obtenir une clé</a>.</p>
            </div>

            <div class="flex flex-col gap-3">
                <button id="save-config" class="w-full bg-[#00FF00] border-4 border-black py-3 font-black uppercase text-xs shadow-[5px_5px_0px_0px_rgba(0,0,0,1)] active:shadow-none transition-all">Save_Config</button>
                <button id="clear-config" class="w-full bg-white border-4 border-black py-2 font-black uppercase text-[10px] text-red-600 hover:bg-red-50">Factory_Reset</button>
                <button id="close-modal" class="w-full bg-black text-white py-3 font-black uppercase text-xs">Exit</button>
            </div>
        </div>
    </div>

    <script>
        // --- State ---
        let repos = [];
        let currentIndex = 0;
        let page = 1;
        let isLoading = false;
        let mode = 'trending'; 
        let readmeCache = {};
        let fetchingIds = new Set();
        let ghToken = localStorage.getItem('gs_gh_token') || "";
        let geminiKey = localStorage.getItem('gs_gemini_key') || "";
        let localVault = JSON.parse(localStorage.getItem('gs_vault') || "[]");
        let remoteStars = [];
        let swipeHistory = []; 
        let currentRepoContext = ""; // For Chat
        let chatHistory = []; // For Chat

        // Default & Loaded Tags
        const defaultTags = ['web', 'tool', 'game', 'ai', 'cli', 'minimal', 'automation', 'ricing', 'tui', 'chat', 'distro', 'xfce', 'window manager', 'hyprland', 'dotfiles', 'programming language'];
        let chaosTags = JSON.parse(localStorage.getItem('gs_chaos_tags') || JSON.stringify(defaultTags));

        // UI Ref
        const cardContainer = document.getElementById('card-container');
        const vaultList = document.getElementById('vault-list');
        const viewDiscover = document.getElementById('view-discover');
        const viewVault = document.getElementById('view-vault');
        const viewAnalyzer = document.getElementById('view-analyzer');
        const vaultTitle = document.getElementById('vault-title');
        const btnTrending = document.getElementById('btn-trending');
        const btnRandom = document.getElementById('btn-random');
        const btnVault = document.getElementById('btn-vault');
        const btnSearch = document.getElementById('btn-search');
        const configModal = document.getElementById('config-modal');
        const searchModal = document.getElementById('search-modal');
        const tagsModal = document.getElementById('tags-modal');
        const btnUndo = document.getElementById('btn-undo');
        const vaultRefreshIndicator = document.getElementById('vault-loading-indicator');

        // --- Moteur de Chaos ---
        const getChaosParams = () => {
            const randomKeyword = chaosTags[Math.floor(Math.random() * chaosTags.length)];
            const r = Math.random();
            let starsParam = r < 0.3 ? "stars:100..500" : r > 0.7 ? "stars:>5000" : "stars:500..5000";
            return { q: `${randomKeyword} ${starsParam}`, sort: Math.random() > 0.5 ? 'updated' : 'stars' };
        };

        const getTrendingParams = () => {
            const date = new Date(); date.setMonth(date.getMonth() - 1);
            return { q: `created:>${date.toISOString().split('T')[0]} stars:>100`, sort: 'stars' };
        };

        const fetchGithub = async (url, method = 'GET', isHtml = false) => {
            const headers = isHtml ? { 'Accept': 'application/vnd.github.html' } : {};
            if (ghToken) headers['Authorization'] = `token ${ghToken}`;
            return await fetch(url, { method, headers });
        };

        // --- Core Logic ---
        const fetchTrendingRepos = async (reset = false) => {
            if (isLoading && !reset) return;
            if (reset) {
                repos = []; currentIndex = 0; page = 1;
                cardContainer.innerHTML = `<div class="flex flex-col items-center justify-center h-full gap-4"><div class="w-12 h-12 border-4 border-black border-t-[#00FF00] animate-spin"></div><p class="font-black uppercase text-[10px] tracking-widest italic opacity-20">Loading_${mode}...</p></div>`;
            }
            isLoading = true;
            try {
                const params = mode === 'random' ? getChaosParams() : getTrendingParams();
                const res = await fetchGithub(`https://api.github.com/search/repositories?q=${encodeURIComponent(params.q)}&sort=${params.sort}&order=desc&per_page=30&page=${page}`);
                if (!res.ok) throw new Error(res.status === 403 ? "LIMIT" : "ERR");
                const data = await res.json();
                const starredIds = new Set((ghToken ? remoteStars : localVault).map(r => r.id));
                const filtered = data.items.filter(r => !starredIds.has(r.id)).sort(() => mode === 'random' ? Math.random() - 0.5 : 0);
                repos = [...repos, ...filtered];
                renderCurrentCard();
            } catch (err) { showToast(err.message === "LIMIT" ? "API LIMIT" : "ERROR", "bg-red-600"); } 
            finally { isLoading = false; }
        };

        const executeSearch = async (rawQuery) => {
            searchModal.classList.add('hidden');
            mode = 'search';
            repos = []; currentIndex = 0;
            updateNavStyles(btnSearch);
            viewDiscover.classList.remove('hidden'); viewVault.classList.add('hidden');
            
            cardContainer.innerHTML = `<div class="flex flex-col items-center justify-center h-full gap-4"><div class="w-12 h-12 border-4 border-black border-t-[#00FF00] animate-spin"></div><p class="font-black uppercase text-[10px] tracking-widest italic">Deep_Scanning...</p></div>`;
            
            try {
                if (rawQuery.includes('/') && !rawQuery.includes(' ')) {
                    const res = await fetchGithub(`https://api.github.com/repos/${rawQuery}`);
                    if (res.ok) { repos = [await res.json()]; renderCurrentCard(); return; }
                }
                const terms = rawQuery.toLowerCase().split(' ');
                const languages = ['javascript', 'js', 'typescript', 'ts', 'python', 'py', 'java', 'go', 'golang', 'rust', 'rs', 'c', 'cpp', 'c++', 'c#', 'php', 'ruby', 'swift', 'kotlin', 'html', 'css', 'shell', 'bash', 'lua', 'dart', 'flutter', 'react', 'vue', 'svelte'];
                const langMap = { 'js': 'javascript', 'ts': 'typescript', 'py': 'python', 'rs': 'rust', 'golang': 'go' };
                let queryParts = []; let langFilter = "";
                terms.forEach(t => { if (languages.includes(t)) { const lang = langMap[t] || t; langFilter = `language:${lang}`; } else { queryParts.push(t); } });
                const cleanQuery = queryParts.join(' ');
                const githubQuery = `${cleanQuery} in:name,description,topics ${langFilter} stars:>10`;
                const res = await fetchGithub(`https://api.github.com/search/repositories?q=${encodeURIComponent(githubQuery)}&sort=stars&order=desc&per_page=50`);
                if (!res.ok) throw new Error("SEARCH_FAILED");
                const data = await res.json();
                if (data.items.length === 0) {
                    const fallbackRes = await fetchGithub(`https://api.github.com/search/repositories?q=${encodeURIComponent(rawQuery)}&sort=stars&per_page=30`);
                    const fallbackData = await fallbackRes.json();
                    if (fallbackData.items.length === 0) throw new Error("NO_RESULTS");
                    repos = fallbackData.items;
                } else { repos = data.items; }
                renderCurrentCard();
            } catch (err) {
                showToast(err.message === "NO_RESULTS" ? "NO REPOS FOUND" : "SEARCH ERROR", "bg-red-600");
                cardContainer.innerHTML = `<div class="flex flex-col items-center justify-center h-full gap-4"><p class="font-black uppercase text-xl">404</p><p class="text-xs uppercase">No Results Found</p></div>`;
            }
        };

        const fetchUserStars = async (silent = false) => {
            if (!ghToken) { renderVaultList(localVault); return; }
            if (!silent) vaultRefreshIndicator.classList.remove('hidden');
            try {
                const res = await fetchGithub(`https://api.github.com/user/starred?per_page=100`);
                if (res.ok) { remoteStars = await res.json(); renderVaultList(remoteStars); }
            } catch (e) {} finally { if (!silent) vaultRefreshIndicator.classList.add('hidden'); }
        };

        const toggleStar = async (repo, action = 'star') => {
            if (!ghToken) {
                if (action === 'star') { if (!localVault.find(r => r.id === repo.id)) localVault.unshift(repo); }
                else { localVault = localVault.filter(r => r.id !== repo.id); }
                localStorage.setItem('gs_vault', JSON.stringify(localVault));
                renderVaultList(localVault);
                return true;
            }
            try {
                const url = `https://api.github.com/user/starred/${repo.owner.login}/${repo.name}`;
                const res = await fetchGithub(url, action === 'star' ? 'PUT' : 'DELETE');
                if (res.status === 204) { await fetchUserStars(true); return true; }
            } catch (e) { showToast("SYNC_FAILED", "bg-red-500"); }
            return false;
        };

        const fetchReadme = async (repo) => {
            if (readmeCache[repo.id] || fetchingIds.has(repo.id)) return;
            fetchingIds.add(repo.id);
            try {
                const res = await fetchGithub(`https://api.github.com/repos/${repo.owner.login}/${repo.name}/readme`, 'GET', true);
                if (!res.ok) throw new Error();
                readmeCache[repo.id] = await res.text();
                if (repos[currentIndex] && repos[currentIndex].id === repo.id) {
                    const box = document.getElementById('readme-box'); if (box) box.innerHTML = readmeCache[repo.id];
                }
            } catch (e) { readmeCache[repo.id] = `<div class="p-10 border-4 border-dashed border-black text-center opacity-30 font-black text-xs">DOCS_NOT_FOUND</div>`; } 
            finally { fetchingIds.delete(repo.id); }
        };

        // --- ANALYZER / CHAT LOGIC ---
        const openAnalyzer = async (repoId) => {
            const repo = (ghToken ? remoteStars : localVault).find(r => r.id == repoId) || repos[currentIndex];
            if (!repo) return;
            if (!geminiKey) { showToast("GEMINI_KEY_REQUIRED", "bg-red-600"); document.getElementById('btn-config').click(); return; }
            viewAnalyzer.classList.remove('hidden');
            document.getElementById('analyzer-title').innerText = `${repo.owner.login}/${repo.name}`;
            document.getElementById('analyzer-chat').innerHTML = `<div class="p-4 border-2 border-black bg-white shadow-[4px_4px_0px_0px_rgba(0,0,0,0.2)]"><p class="font-bold text-xs uppercase mb-2 text-[#00FF00] bg-black inline-block px-1">SYSTEM</p><p class="text-xs">Démarrage de l'analyseur pour ${repo.name}...</p></div>`;
            document.getElementById('analyzer-loading').classList.remove('hidden');
            document.getElementById('analyzer-chat').classList.add('hidden');
            chatHistory = []; currentRepoContext = "";
            try {
                document.getElementById('analyzer-status').innerText = "Fetching_Tree...";
                const treeRes = await fetchGithub(`https://api.github.com/repos/${repo.owner.login}/${repo.name}/git/trees/${repo.default_branch || 'main'}?recursive=1`);
                if(!treeRes.ok) throw new Error("REPO_ACCESS_DENIED");
                const treeData = await treeRes.json();
                const files = treeData.tree.filter(f => f.type === 'blob' && /\.(js|jsx|ts|tsx|py|html|css|json|md|c|cpp|go|rs|php|java|rb)$/.test(f.path) && !f.path.match(/node_modules|dist|\.git|lock|package-lock/)).slice(0, 150);
                if(files.length === 0) throw new Error("NO_CODE_FOUND");
                document.getElementById('analyzer-status').innerText = `Downloading_Blobs (${files.length})...`;
                const progress = document.getElementById('analyzer-progress');
                let downloadedContent = "";
                for(let i=0; i<files.length; i+=5) {
                    const batch = files.slice(i, i+5);
                    const contents = await Promise.all(batch.map(f => fetch(f.url, ghToken ? {headers:{'Authorization':`token ${ghToken}`}} : {}).then(r=>r.json()).then(d => d.content ? `\n-- ${f.path} --\n${new TextDecoder().decode(Uint8Array.from(atob(d.content),c=>c.charCodeAt(0)))}` : "").catch(e=>"")));
                    downloadedContent += contents.join("");
                    progress.style.width = `${(i/files.length)*100}%`;
                    document.getElementById('analyzer-details').innerText = `${i}/${files.length} segments loaded`;
                }
                currentRepoContext = downloadedContent;
                document.getElementById('analyzer-loading').classList.add('hidden');
                document.getElementById('analyzer-chat').classList.remove('hidden');
                addChatMessage("AI", `Analyse terminée. J'ai indexé **${files.length} fichiers**. Posez votre question.`);
            } catch (e) {
                document.getElementById('analyzer-loading').classList.add('hidden');
                document.getElementById('analyzer-chat').classList.remove('hidden');
                addChatMessage("AI", `Erreur Critique: ${e.message}. Impossible d'analyser ce dépôt.`);
            }
        };
        const closeAnalyzer = () => { viewAnalyzer.classList.add('hidden'); };
        const sendMessage = async () => {
            const input = document.getElementById('chat-input');
            const q = input.value.trim();
            if (!q || !geminiKey) return;
            input.value = ""; document.getElementById('btn-send').disabled = true; document.getElementById('btn-send').innerText = "...";
            addChatMessage("User", q);
            const context = `Tu es un expert en code. Analyse ce code source:\n${currentRepoContext.slice(0, 30000)}...\n(Tronqué si trop long)\n\nHistorique:\n${chatHistory.slice(-4).map(x=>x.role+': '+x.text).join('\n')}\nUtilisateur: ${q}\nRéponds de manière concise, technique, et formatée en Markdown.`;
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiKey}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: context }] }] }) });
                if (!res.ok) throw new Error((await res.json()).error?.message || "API Error");
                const data = await res.json();
                const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "No response";
                addChatMessage("AI", reply);
            } catch (e) { addChatMessage("AI", `Erreur API Gemini: ${e.message}`); } 
            finally { document.getElementById('btn-send').disabled = false; document.getElementById('btn-send').innerText = "SEND"; }
        };
        const addChatMessage = (role, text) => {
            const div = document.createElement('div');
            div.className = `p-4 mb-4 rounded-none max-w-[85%] ${role === 'User' ? 'msg-user' : 'msg-ai'} shadow-[4px_4px_0px_0px_rgba(0,0,0,0.5)]`;
            let contentHtml = role === 'AI' ? marked.parse(text) : text;
            div.innerHTML = `<div class="font-black text-[10px] uppercase mb-1 opacity-50">${role === 'User' ? 'YOU' : 'GEMINI_CORE'}</div><div class="markdown-body text-xs">${contentHtml}</div>`;
            const container = document.getElementById('analyzer-chat'); container.appendChild(div); container.scrollTop = container.scrollHeight;
            if(role === 'AI') div.querySelectorAll('pre code').forEach(hljs.highlightElement);
            chatHistory.push({role, text});
        };

        // --- Swipe Logic ---
        let startX = 0, startY = 0, currentX = 0, currentY = 0, isDragging = false, swipeIntent = null; 
        const handleStart = (e) => { 
            if (e.target.closest('button, a, input')) return;
            if (viewDiscover.classList.contains('hidden')) return;
            isDragging = true; swipeIntent = null; 
            startX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX; 
            startY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY; 
            currentX = startX; currentY = startY; 
            const card = document.querySelector('.active-card');
            if (card) card.style.transition = 'none';
        };
        
        const handleMove = (e) => {
            if (!isDragging) return;
            currentX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX; 
            currentY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            const dx = currentX - startX;
            const dy = currentY - startY;
            if (!swipeIntent) {
                if (Math.abs(dx) > 15) swipeIntent = 'horizontal';
                else if (Math.abs(dy) > 15) swipeIntent = 'vertical';
            }
            if (swipeIntent === 'horizontal') { 
                if (e.cancelable) e.preventDefault(); 
                const card = document.querySelector('.active-card'); 
                if (card) { 
                    card.style.transform = `translate(${dx}px, ${dy * 0.05}px) rotate(${dx / 20}deg)`; 
                    updateFeedback(dx); 
                } 
            }
        };

        const handleEnd = () => { 
            if (!isDragging) return; 
            isDragging = false; 
            if (swipeIntent === 'horizontal') { 
                const dx = currentX - startX; 
                if (dx > 100) completeSwipe('right'); 
                else if (dx < -100) completeSwipe('left'); 
                else resetCard(); 
            } else {
                resetCard();
            }
            swipeIntent = null;
        };

        const resetCard = () => { 
            const card = document.querySelector('.active-card'); 
            if (card) { 
                card.style.transition = "transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)"; 
                card.style.transform = `translate(0,0) rotate(0)`; 
                document.getElementById('feedback').classList.add('hidden'); 
            } 
        };

        const updateFeedback = (dx) => { 
            const fb = document.getElementById('feedback'); 
            if (Math.abs(dx) < 40) { fb.classList.add('hidden'); return; } 
            fb.classList.remove('hidden'); 
            fb.innerText = dx > 0 ? "STAR" : "SKIP"; 
            fb.className = `absolute top-1/2 -translate-y-1/2 z-50 px-10 py-5 border-4 border-black font-black text-4xl uppercase shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] pointer-events-none ${dx > 0 ? 'right-4 bg-[#00FF00] text-black rotate-3' : 'left-4 bg-black text-white -rotate-3'}`; 
        };

        const completeSwipe = async (dir) => {
            const card = document.querySelector('.active-card'); if (!card) return;
            swipeHistory.push({ index: currentIndex, direction: dir, repo: repos[currentIndex] }); updateUndoButton();
            card.style.transition = "transform 0.2s ease-in"; card.style.transform = `translate(${dir === 'right' ? 800 : -800}px, 0) rotate(${dir === 'right' ? 30 : -30}deg)`;
            if (dir === 'right') await toggleStar(repos[currentIndex], 'star');
            setTimeout(() => { currentIndex++; if (currentIndex >= repos.length - 8 && mode !== 'search') { page++; fetchTrendingRepos(); } renderCurrentCard(); }, 120);
        };

        const undoLastSwipe = async () => {
            if (swipeHistory.length === 0) return;
            const lastAction = swipeHistory.pop(); updateUndoButton();
            if (lastAction.direction === 'right') await toggleStar(lastAction.repo, 'unstar');
            currentIndex = lastAction.index; renderCurrentCard(true); showToast("UNDO", "bg-black text-white");
        };

        const updateUndoButton = () => { if (swipeHistory.length > 0) { btnUndo.classList.replace('opacity-30', 'opacity-100'); btnUndo.classList.replace('cursor-not-allowed', 'cursor-pointer'); } else { btnUndo.classList.replace('opacity-100', 'opacity-30'); btnUndo.classList.replace('cursor-pointer', 'cursor-not-allowed'); } };

        // --- TAGS MANAGEMENT ---
        const renderTags = () => {
            const list = document.getElementById('tags-list');
            list.innerHTML = chaosTags.map(tag => `
                <div class="inline-flex items-center bg-black text-[#00FF00] px-3 py-1 border-2 border-black text-[10px] font-bold uppercase gap-2">
                    <span>${tag}</span>
                    <button onclick="removeTag('${tag}')" class="hover:text-white">x</button>
                </div>
            `).join('');
        };

        window.removeTag = (tag) => {
            chaosTags = chaosTags.filter(t => t !== tag);
            renderTags();
        };

        document.getElementById('open-tags-btn').onclick = () => {
            configModal.classList.add('hidden');
            tagsModal.classList.remove('hidden');
            renderTags();
        };

        document.getElementById('add-tag-btn').onclick = () => {
            const val = document.getElementById('new-tag-input').value.trim().toLowerCase();
            if (val && !chaosTags.includes(val)) {
                chaosTags.push(val);
                document.getElementById('new-tag-input').value = "";
                renderTags();
            }
        };

        document.getElementById('reset-tags').onclick = () => {
            chaosTags = JSON.parse(JSON.stringify(defaultTags));
            renderTags();
        };

        document.getElementById('close-tags').onclick = () => {
            localStorage.setItem('gs_chaos_tags', JSON.stringify(chaosTags));
            tagsModal.classList.add('hidden');
            configModal.classList.remove('hidden');
            showToast("TAGS_UPDATED", "bg-[#00FF00] text-black");
        };

        // --- Common Helpers ---
        const showToast = (msg, classes) => { const toast = document.createElement('div'); toast.className = `fixed bottom-10 left-1/2 -translate-x-1/2 px-8 py-3 border-4 border-black font-black uppercase text-[10px] z-[200] shadow-[6px_6px_0px_0px_rgba(0,0,0,1)] ${classes}`; toast.innerText = msg; document.body.appendChild(toast); setTimeout(() => toast.remove(), 1500); };
        
        const updateNavStyles = (activeBtn) => { 
            [btnTrending, btnRandom, btnVault, btnSearch].forEach(b => { 
                if (b === activeBtn) { b.classList.add('bg-[#00FF00]', 'text-black', 'shadow-[2px_2px_0px_0px_rgba(255,255,255,1)]', 'translate-x-[-1px]', 'translate-y-[-1px]'); } 
                else { b.classList.remove('bg-[#00FF00]', 'text-black', 'shadow-[2px_2px_0px_0px_rgba(255,255,255,1)]', 'translate-x-[-1px]', 'translate-y-[-1px]'); b.classList.add('hover:bg-white', 'hover:text-black'); } 
            }); 
        };

        btnTrending.onclick = () => { mode = 'trending'; viewDiscover.classList.remove('hidden'); viewVault.classList.add('hidden'); updateNavStyles(btnTrending); fetchTrendingRepos(true); };
        btnRandom.onclick = () => { mode = 'random'; viewDiscover.classList.remove('hidden'); viewVault.classList.add('hidden'); updateNavStyles(btnRandom); fetchTrendingRepos(true); };
        btnVault.onclick = async () => { viewVault.classList.remove('hidden'); viewDiscover.classList.add('hidden'); updateNavStyles(btnVault); await fetchUserStars(); };
        btnSearch.onclick = () => { searchModal.classList.remove('hidden'); document.getElementById('search-input').focus(); };
        
        document.getElementById('close-search').onclick = () => searchModal.classList.add('hidden');
        document.getElementById('btn-do-search').onclick = () => executeSearch(document.getElementById('search-input').value.trim());
        document.getElementById('search-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') executeSearch(e.target.value.trim()); });

        document.getElementById('btn-config').onclick = () => {
            document.getElementById('gh-token-input').value = ghToken;
            document.getElementById('gemini-key-input').value = geminiKey;
            configModal.classList.remove('hidden');
        };
        document.getElementById('close-modal').onclick = () => configModal.classList.add('hidden');
        document.getElementById('save-config').onclick = () => {
            ghToken = document.getElementById('gh-token-input').value.trim();
            geminiKey = document.getElementById('gemini-key-input').value.trim();
            localStorage.setItem('gs_gh_token', ghToken);
            localStorage.setItem('gs_gemini_key', geminiKey);
            showToast("CONFIG_SAVED", "bg-[#00FF00] text-black");
            configModal.classList.add('hidden');
            fetchTrendingRepos(true);
        };
        document.getElementById('clear-config').onclick = () => {
            localStorage.removeItem('gs_gh_token'); localStorage.removeItem('gs_gemini_key');
            window.location.reload();
        };

        // --- Event Listeners Scoped ---
        cardContainer.addEventListener('mousedown', handleStart);
        cardContainer.addEventListener('touchstart', handleStart, { passive: false });

        window.addEventListener('mousemove', handleMove);
        window.addEventListener('mouseup', handleEnd);
        window.addEventListener('touchmove', handleMove, { passive: false }); 
        window.addEventListener('touchend', handleEnd);

        // --- Render Current Card ---
        const renderCurrentCard = (isUndo = false) => {
            const repo = repos[currentIndex]; if (!repo) return;
            if (mode !== 'search') for(let i=1; i<=3; i++) if(repos[currentIndex+i]) fetchReadme(repos[currentIndex+i]);
            
            cardContainer.innerHTML = `
                <div class="active-card absolute inset-0 bg-white border-4 border-black shadow-[10px_10px_0px_0px_rgba(0,0,0,1)] flex flex-col overflow-hidden ${isUndo ? 'card-undo-anim' : ''}">
                    <div class="p-4 border-b-4 border-black bg-white flex justify-between items-center shrink-0">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <img src="${repo.owner.avatar_url}" class="w-10 h-10 border-2 border-black" draggable="false">
                            <div class="overflow-hidden leading-none">
                                <p class="text-[9px] font-black uppercase text-black/40 mb-1">${repo.owner.login}</p>
                                <h2 class="font-black text-base uppercase truncate leading-none">${repo.name}</h2>
                            </div>
                        </div>
                        <div class="bg-[#00FF00] border-2 border-black px-2 py-1 text-[10px] font-black shrink-0">★ ${repo.stargazers_count}</div>
                    </div>
                    <div class="scrollable-content flex-1 overflow-y-auto overflow-x-hidden p-5 custom-scrollbar bg-white">
                        <div class="p-4 border-2 border-black bg-[#f0f0f0] mb-5 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]">
                            <p class="text-xs font-black uppercase italic leading-tight">"${repo.description || "NO_SUMMARY_FOUND"}"</p>
                        </div>
                        <div id="readme-box" class="markdown-body border-t-4 border-black pt-6">
                            ${readmeCache[repo.id] || `<div class="py-20 flex flex-col items-center gap-2 opacity-20"><div class="w-6 h-6 border-4 border-black border-t-[#00FF00] animate-spin"></div><span class="text-[9px] font-black uppercase italic">Decrypting_Data...</span></div>`}
                        </div>
                    </div>
                    <div class="p-3 border-t-4 border-black bg-white shrink-0 flex gap-2">
                        <button onclick="openAnalyzer('${repo.id}')" class="flex-1 py-3 bg-white text-black border-2 border-black font-black uppercase text-[10px] shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] active:shadow-none transition-all hover:bg-[#00FF00]">
                            Chat_AI
                        </button>
                        <a href="${repo.html_url}" target="_blank" class="flex-1 block text-center py-3 bg-black text-[#00FF00] border-2 border-black font-black uppercase text-[10px] shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] active:shadow-none transition-all hover:translate-x-[1px] hover:translate-y-[1px]">
                            Open_Repo
                        </a>
                    </div>
                </div>
            `;
            if (!readmeCache[repo.id]) fetchReadme(repo);
            document.getElementById('feedback').classList.add('hidden');
        };

        // --- Render Vault List (RESTORED) ---
        const renderVaultList = (list) => {
            vaultTitle.innerText = ghToken ? "Stars" : "Vault";
            if (list.length === 0) { vaultList.innerHTML = `<div class="p-20 border-4 border-dashed border-black text-center opacity-20 font-black uppercase text-xs italic">Sector_Empty</div>`; return; }
            vaultList.innerHTML = list.map(f => `
                <div onclick="openAnalyzer('${f.id}')" class="cursor-pointer bg-white p-4 border-4 border-black shadow-[6px_6px_0px_0px_rgba(0,0,0,1)] flex items-center gap-4 hover:translate-x-1 transition-transform group">
                    <img src="${f.owner.avatar_url}" class="w-10 h-10 border-2 border-black shrink-0">
                    <div class="flex-1 overflow-hidden">
                        <h4 class="font-black uppercase truncate text-xs group-hover:text-[#00aa00] transition-colors">${f.name}</h4>
                        <p class="text-[9px] font-black uppercase opacity-40">★ ${f.stargazers_count}</p>
                    </div>
                    <div class="flex gap-2 shrink-0">
                        <a href="${f.html_url}" target="_blank" onclick="event.stopPropagation()" class="p-2 border-2 border-black bg-black text-[#00FF00] hover:bg-[#00FF00] hover:text-black transition-colors"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6M15 3h6v6M10 14L21 3"/></svg></a>
                        <button onclick="event.stopPropagation(); unstar('${f.owner.login}', '${f.name}', ${f.id})" class="p-2 border-2 border-black hover:bg-red-600 hover:text-white transition-colors"><svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M10 11v6M14 11v6"/></svg></button>
                    </div>
                </div>
            `).join('');
        };

        fetchUserStars(true).then(() => fetchTrendingRepos());
    </script>
</body>
</html>
